<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sauber Air Monitoring System</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <style>
    :root {
      --primary-color: #007AFF;
      --card-bg: rgba(255, 255, 255, 0.9);
      --card-border: rgba(0, 0, 0, 0.1);
      --text-primary: #1C1C1E;
      --text-secondary: #636366;
      --blur-effect: saturate(180%) blur(20px);
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
      margin: 0;
      padding: 0;
      background: linear-gradient(160deg, #E6F2FF 0%, #F0F5FF 100%);
      color: var(--text-primary);
      min-height: 100vh;
    }
    
    .container {
      max-width: 600px;
      margin: 0 auto;
      padding: 20px;
      display: flex;
      flex-direction: column;
      gap: 20px;
    }
    
    /* –ó–∞–≥–æ–ª–æ–≤–æ–∫ —Å–∏—Å—Ç–µ–º—ã */
    .system-title {
      font-size: 24px;
      font-weight: 600;
      color: #000;
      text-align: center;
      margin-bottom: 10px;
    }
    
    /* –ö–∞—Ä—Ç–æ—á–∫–∏ –≤ —Å—Ç–∏–ª–µ Apple */
    .card {
      background: var(--card-bg);
      backdrop-filter: var(--blur-effect);
      -webkit-backdrop-filter: var(--blur-effect);
      border-radius: 18px;
      padding: 20px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
      border: 1px solid var(--card-border);
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }
    
    .card:hover {
      transform: translateY(-5px);
      box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15);
    }
    
    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }
    
    .card-title {
      margin: 0;
      font-size: 1.4rem;
      font-weight: 600;
      color: var(--text-primary);
    }
    
    /* –ö–∞—Ä—Ç—ã –ø–æ–≥–æ–¥—ã */
    .weather-map-container {
      height: 300px;
      border-radius: 12px;
      overflow: hidden;
      margin-bottom: 15px;
      position: relative;
      border: 2px solid #000;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }
    
    .weather-map {
      height: 100%;
      width: 100%;
    }
    
    .map-controls {
      position: absolute;
      top: 10px;
      right: 10px;
      z-index: 1000;
      display: flex;
      flex-direction: column;
      gap: 5px;
    }
    
    .map-layer-btn {
      background: rgba(255, 255, 255, 0.9);
      border: 2px solid #000;
      border-radius: 8px;
      padding: 5px 10px;
      font-size: 12px;
      cursor: pointer;
      font-weight: 500;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    
    /* –ü—Ä–æ–≥–Ω–æ–∑ –Ω–∞ –Ω–µ–¥–µ–ª—é */
    .forecast-wrapper {
      width: 100%;
      overflow-x: auto;
      padding-bottom: 10px;
    }
    
    .forecast-container {
      display: flex;
      gap: 10px;
      width: max-content;
      padding: 5px;
    }
    
    .forecast-day {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 10px;
      min-width: 70px;
      border-radius: 12px;
      background: rgba(255, 255, 255, 0.5);
      transition: all 0.3s ease;
      border: 2px solid #000;
      box-shadow: 0 3px 6px rgba(0, 0, 0, 0.1);
    }
    
    .forecast-day:hover {
      background: rgba(255, 255, 255, 0.7);
    }
    
    .forecast-dayname {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 5px;
    }
    
    .forecast-icon img {
      width: 36px;
      height: 36px;
    }
    
    .forecast-temp {
      font-size: 16px;
      font-weight: 600;
      margin-top: 5px;
    }
    
    /* –°–∫—Ä—ã—Ç—å —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π —Å–∫—Ä–æ–ª–ª–±–∞—Ä */
    .forecast-wrapper::-webkit-scrollbar {
      height: 5px;
    }
    
    .forecast-wrapper::-webkit-scrollbar-track {
      background: rgba(0, 0, 0, 0.1);
      border-radius: 10px;
    }
    
    .forecast-wrapper::-webkit-scrollbar-thumb {
      background: rgba(0, 0, 0, 0.2);
      border-radius: 10px;
    }
    
    /* –ë–ª–æ–∫ –ø–æ–∫–∞–∑–∞–Ω–∏–π –¥–∞—Ç—á–∏–∫–∞ */
    .sensor-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 15px;
      margin-top: 10px;
    }
    
    .sensor-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 15px;
      border-radius: 14px;
      background: rgba(255, 255, 255, 0.5);
      transition: all 0.3s ease;
      border: 2px solid #000;
      box-shadow: 0 3px 6px rgba(0, 0, 0, 0.1);
    }
    
    .sensor-item:hover {
      background: rgba(255, 255, 255, 0.7);
    }
    
    .sensor-value {
      font-size: 20px;
      font-weight: 600;
      margin: 5px 0;
    }
    
    .sensor-label {
      font-size: 14px;
      color: var(--text-secondary);
      font-weight: 500;
    }
    
    /* –ë–ª–æ–∫ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –ø–æ–≥–æ–¥—ã */
    .weather-params {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
      margin-top: 15px;
    }
    
    .param-item {
      display: flex;
      align-items: center;
      padding: 12px;
      border-radius: 12px;
      background: rgba(255, 255, 255, 0.5);
      border: 2px solid #000;
      box-shadow: 0 3px 6px rgba(0, 0, 0, 0.1);
    }
    
    .param-icon {
      font-size: 20px;
      width: 30px;
      color: var(--primary-color);
    }
    
    .param-value {
      font-weight: 600;
    }
    
    .param-label {
      font-size: 12px;
      color: var(--text-secondary);
      font-weight: 500;
    }
    
    /* –ö–∞—á–µ—Å—Ç–≤–æ –≤–æ–∑–¥—É—Ö–∞ */
    .air-quality {
      margin-top: 20px;
    }
    
    .quality-item {
      margin-bottom: 12px;
    }
    
    .quality-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px;
      border-radius: 10px;
      background: rgba(255, 255, 255, 0.5);
      cursor: pointer;
      transition: all 0.3s ease;
      border: 2px solid #000;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    
    .quality-header:hover {
      background: rgba(255, 255, 255, 0.7);
    }
    
    .quality-indicator {
      height: 6px;
      border-radius: 3px;
      margin-top: 8px;
      background: linear-gradient(to right, #4CAF50, #FFEB3B, #F44336);
      transition: all 0.5s ease;
    }
    
    .quality-info {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease;
      padding: 0 10px;
    }
    
    .quality-info.active {
      max-height: 200px;
      padding: 10px;
    }
    
    .quality-info p {
      margin: 8px 0;
      font-size: 14px;
      line-height: 1.4;
      color: var(--text-secondary);
    }
    
    /* –ö–Ω–æ–ø–∫–∏ */
    button {
      background: rgba(0, 122, 255, 0.1);
      color: var(--primary-color);
      border: 2px solid #000;
      padding: 8px 16px;
      border-radius: 10px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      transition: all 0.3s ease;
      backdrop-filter: var(--blur-effect);
      -webkit-backdrop-filter: var(--blur-effect);
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    
    button:hover {
      background: rgba(0, 122, 255, 0.2);
    }
    
    button i {
      margin-right: 5px;
    }
    
    /* –°—Ç–∞—Ç—É—Å */
    .status {
      margin-top: 15px;
      padding: 10px;
      border-radius: 10px;
      text-align: center;
      font-size: 14px;
      font-weight: 500;
      background: rgba(255, 255, 255, 0.5);
      border: 2px solid #000;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    
    .online {
      color: #34C759;
    }
    
    .offline {
      color: #FF3B30;
    }
    
    /* –ö–∞—Ä—Ç–∞ –¥–∞—Ç—á–∏–∫–∞ */
    #sensor-map-container {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: white;
      z-index: 1000;
      display: none;
    }
    
    #sensor-map {
      height: 90%;
      width: 100%;
    }
    
    #close-sensor-map-btn {
      position: absolute;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(255, 59, 48, 0.1);
      color: #FF3B30;
      padding: 10px 20px;
    }
    
    /* –ê–Ω–∏–º–∞—Ü–∏–∏ */
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .card {
      animation: fadeIn 0.5s ease forwards;
    }
    
    .card:nth-child(1) { animation-delay: 0.1s; }
    .card:nth-child(2) { animation-delay: 0.2s; }
    .card:nth-child(3) { animation-delay: 0.3s; }
  </style>
</head>
<body>
  <div class="container">
    <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ —Å–∏—Å—Ç–µ–º—ã -->
    <h1 class="system-title">Sauber Air Monitoring System</h1>
    
    <!-- –ë–ª–æ–∫ –ø–æ–≥–æ–¥—ã -->
    <div class="card">
      <div class="card-header">
        <h2 class="card-title">–ü–æ–≥–æ–¥–∞ –≤ –ß–µ–ª—è–±–∏–Ω—Å–∫–µ</h2>
        <button id="refresh-weather" type="button"><i class="fas fa-sync-alt"></i>–û–±–Ω–æ–≤–∏—Ç—å</button>
      </div>
      
      <!-- –ö–∞—Ä—Ç–∞ –ø–æ–≥–æ–¥—ã -->
      <div class="weather-map-container">
        <div id="weather-map" class="weather-map"></div>
        <div class="map-controls">
          <button class="map-layer-btn" onclick="changeWeatherLayer('temp_new')">–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞</button>
          <button class="map-layer-btn" onclick="changeWeatherLayer('clouds_new')">–û–±–ª–∞–∫–∞</button>
          <button class="map-layer-btn" onclick="changeWeatherLayer('precipitation_new')">–û—Å–∞–¥–∫–∏</button>
          <button class="map-layer-btn" onclick="changeWeatherLayer('wind_new')">–í–µ—Ç–µ—Ä</button>
          <button class="map-layer-btn" onclick="changeWeatherLayer('pressure_new')">–î–∞–≤–ª–µ–Ω–∏–µ</button>
        </div>
      </div>
      
      <!-- –ü—Ä–æ–≥–Ω–æ–∑ –Ω–∞ –Ω–µ–¥–µ–ª—é -->
      <div class="forecast-wrapper">
        <div class="forecast-container" id="forecast-container">
          <!-- –ü—Ä–æ–≥–Ω–æ–∑ –±—É–¥–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω –∑–¥–µ—Å—å -->
        </div>
      </div>
    </div>
    
    <!-- –ë–ª–æ–∫ –Ω–∞—à–µ–≥–æ –¥–∞—Ç—á–∏–∫–∞ -->
    <div class="card">
      <div class="card-header">
        <h2 class="card-title">–ú–µ—Ç–µ–æ—Å—Ç–∞–Ω—Ü–∏—è –ü–∞—Ä–∫–æ–≤—ã–π</h2>
        <button id="show-sensor-map-btn" type="button"><i class="fas fa-map-marked-alt"></i>–ö–∞—Ä—Ç–∞</button>
      </div>
      
      <div class="sensor-grid">
        <div class="sensor-item">
          <div class="sensor-value" id="temp">--¬∞</div>
          <div class="sensor-label">–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞</div>
        </div>
        <div class="sensor-item">
          <div class="sensor-value" id="pressure">-- –≥–ü–∞</div>
          <div class="sensor-label">–î–∞–≤–ª–µ–Ω–∏–µ</div>
        </div>
        <div class="sensor-item">
          <div class="sensor-value" id="altitude">-- –º</div>
          <div class="sensor-label">–í—ã—Å–æ—Ç–∞</div>
        </div>
      </div>
      
      <div class="air-quality">
        <h3 style="margin-bottom: 15px;">–ö–∞—á–µ—Å—Ç–≤–æ –≤–æ–∑–¥—É—Ö–∞ <i class="fas fa-info-circle" style="color: var(--primary-color);"></i></h3>
        
        <div class="quality-item">
          <div class="quality-header" onclick="toggleInfo('pm1_0_info')">
            <span>PM1.0: <span id="pm1_0" class="quality-value">--</span> ¬µg/m¬≥</span>
            <i class="fas fa-chevron-down"></i>
          </div>
          <div class="quality-indicator" id="pm1_0_indicator"></div>
          <div class="quality-info" id="pm1_0_info">
            <p><strong>PM1.0</strong> - —É–ª—å—Ç—Ä–∞–º–µ–ª–∫–∏–µ —á–∞—Å—Ç–∏—Ü—ã –¥–∏–∞–º–µ—Ç—Ä–æ–º –º–µ–Ω–µ–µ 1 –º–∏–∫—Ä–æ–Ω–∞.</p>
            <p><i class="fas fa-lungs"></i> <strong>–í–ª–∏—è–Ω–∏–µ:</strong> –ú–æ–≥—É—Ç –ø—Ä–æ–Ω–∏–∫–∞—Ç—å –≥–ª—É–±–æ–∫–æ –≤ –ª—ë–≥–∫–∏–µ –∏ –¥–∞–∂–µ –≤ –∫—Ä–æ–≤–µ–Ω–æ—Å–Ω—É—é —Å–∏—Å—Ç–µ–º—É.</p>
          </div>
        </div>
        
        <div class="quality-item">
          <div class="quality-header" onclick="toggleInfo('pm2_5_info')">
            <span>PM2.5: <span id="pm2_5" class="quality-value">--</span> ¬µg/m¬≥</span>
            <i class="fas fa-chevron-down"></i>
          </div>
          <div class="quality-indicator" id="pm2_5_indicator"></div>
          <div class="quality-info" id="pm2_5_info">
            <p><strong>PM2.5</strong> - –º–µ–ª–∫–∏–µ —á–∞—Å—Ç–∏—Ü—ã –¥–∏–∞–º–µ—Ç—Ä–æ–º –º–µ–Ω–µ–µ 2.5 –º–∏–∫—Ä–æ–Ω.</p>
            <p><i class="fas fa-lungs"></i> <strong>–í–ª–∏—è–Ω–∏–µ:</strong> –û–ø–∞—Å–Ω—ã –¥–ª—è –∑–¥–æ—Ä–æ–≤—å—è, –≤—ã–∑—ã–≤–∞—é—Ç —Ä–µ—Å–ø–∏—Ä–∞—Ç–æ—Ä–Ω—ã–µ –∑–∞–±–æ–ª–µ–≤–∞–Ω–∏—è.</p>
            <p><i class="fas fa-clipboard-check"></i> <strong>–ù–æ—Ä–º—ã:</strong> –í–û–ó —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç –Ω–µ –±–æ–ª–µ–µ 25 ¬µg/m¬≥ –≤ —Å—É—Ç–∫–∏.</p>
          </div>
        </div>
        
        <div class="quality-item">
          <div class="quality-header" onclick="toggleInfo('pm10_info')">
            <span>PM10: <span id="pm10" class="quality-value">--</span> ¬µg/m¬≥</span>
            <i class="fas fa-chevron-down"></i>
          </div>
          <div class="quality-indicator" id="pm10_indicator"></div>
          <div class="quality-info" id="pm10_info">
            <p><strong>PM10</strong> - –∫—Ä—É–ø–Ω—ã–µ —á–∞—Å—Ç–∏—Ü—ã –¥–∏–∞–º–µ—Ç—Ä–æ–º –º–µ–Ω–µ–µ 10 –º–∏–∫—Ä–æ–Ω.</p>
            <p><i class="fas fa-lungs"></i> <strong>–í–ª–∏—è–Ω–∏–µ:</strong> –û—Å–µ–¥–∞—é—Ç –≤ –≤–µ—Ä—Ö–Ω–∏—Ö –¥—ã—Ö–∞—Ç–µ–ª—å–Ω—ã—Ö –ø—É—Ç—è—Ö.</p>
            <p><i class="fas fa-clipboard-check"></i> <strong>–ù–æ—Ä–º—ã:</strong> –í–û–ó —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç –Ω–µ –±–æ–ª–µ–µ 50 ¬µg/m¬≥ –≤ —Å—É—Ç–∫–∏.</p>
          </div>
        </div>
      </div>
      
      <div id="status" class="status offline">–ù–µ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º</div>
    </div>
    
    <!-- –ë–ª–æ–∫ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –ø–æ–≥–æ–¥—ã -->
    <div class="card">
      <div class="card-header">
        <h2 class="card-title">–ü–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–æ–≥–æ–¥—ã</h2>
      </div>
      
      <div class="weather-params">
        <div class="param-item">
          <div class="param-icon"><i class="fas fa-wind"></i></div>
          <div>
            <div class="param-value" id="weather-wind">-- –º/—Å</div>
            <div class="param-label">–í–µ—Ç–µ—Ä</div>
          </div>
        </div>
        <div class="param-item">
          <div class="param-icon"><i class="fas fa-tint"></i></div>
          <div>
            <div class="param-value" id="weather-humidity">--%</div>
            <div class="param-label">–í–ª–∞–∂–Ω–æ—Å—Ç—å</div>
          </div>
        </div>
        <div class="param-item">
          <div class="param-icon"><i class="fas fa-cloud-rain"></i></div>
          <div>
            <div class="param-value" id="weather-precipitation">-- –º–º</div>
            <div class="param-label">–û—Å–∞–¥–∫–∏</div>
          </div>
        </div>
        <div class="param-item">
          <div class="param-icon"><i class="fas fa-eye"></i></div>
          <div>
            <div class="param-value" id="weather-visibility">-- –∫–º</div>
            <div class="param-label">–í–∏–¥–∏–º–æ—Å—Ç—å</div>
          </div>
        </div>
      </div>
    </div>
    
    <div id="sensor-map-container">
      <div id="sensor-map"></div>
      <button id="close-sensor-map-btn" type="button"><i class="fas fa-times"></i> –ó–∞–∫—Ä—ã—Ç—å –∫–∞—Ä—Ç—É</button>
    </div>
  </div>

  <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º—ã–µ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ -->
  <script src="https://www.gstatic.com/firebasejs/8.2.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.2.1/firebase-database.js"></script>
  <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/js/all.min.js"></script>
  
  <script>
    // –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Firebase
    const firebaseConfig = {
      apiKey: "W5UxNy6wP8sRXfTVWhJK2U3iY6ta4mQRs0AQz8vA",
      authDomain: "sauberweather.firebaseapp.com",
      databaseURL: "https://sauberweather-default-rtdb.firebaseio.com",
      projectId: "sauberweather",
      storageBucket: "sauberweather.appspot.com",
      messagingSenderId: "YOUR_SENDER_ID",
      appId: "1:YOUR_APP_ID:web:YOUR_APP_ID"
    };

    // –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è OpenWeatherMap
    const weatherConfig = {
      apiKey: "38a08d0b9ccb65b9efcf357ccb9622eb",
      city: "Chelyabinsk",
      lat: 55.16,
      lon: 61.40,
      units: "metric",
      lang: "ru"
    };

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Firebase
    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();

    // –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –¥–∞—Ç—á–∏–∫–∞
    const SENSOR_COORDS = [55.215463, 61.291353];

    // –≠–ª–µ–º–µ–Ω—Ç—ã –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
    const elements = {
      // –ü–æ–≥–æ–¥–∞
      weatherWind: document.getElementById("weather-wind"),
      weatherHumidity: document.getElementById("weather-humidity"),
      weatherPrecipitation: document.getElementById("weather-precipitation"),
      weatherVisibility: document.getElementById("weather-visibility"),
      refreshWeatherBtn: document.getElementById("refresh-weather"),
      forecastContainer: document.getElementById("forecast-container"),
      
      // –î–∞—Ç—á–∏–∫
      temp: document.getElementById("temp"),
      pressure: document.getElementById("pressure"),
      altitude: document.getElementById("altitude"),
      pm1_0: document.getElementById("pm1_0"),
      pm2_5: document.getElementById("pm2_5"),
      pm10: document.getElementById("pm10"),
      pm1_0_indicator: document.getElementById("pm1_0_indicator"),
      pm2_5_indicator: document.getElementById("pm2_5_indicator"),
      pm10_indicator: document.getElementById("pm10_indicator"),
      status: document.getElementById("status"),
      showSensorMapBtn: document.getElementById("show-sensor-map-btn"),
      
      // –ö–∞—Ä—Ç—ã
      closeSensorMapBtn: document.getElementById("close-sensor-map-btn"),
      sensorMapContainer: document.getElementById("sensor-map-container"),
      sensorMap: null,
      sensorMarker: null,
      weatherMap: null,
      currentWeatherLayer: null
    };

    // ===== –§–£–ù–ö–¶–ò–ò –î–õ–Ø –ù–ê–®–ï–ì–û –î–ê–¢–ß–ò–ö–ê =====
    function toggleInfo(id) {
      const element = document.getElementById(id);
      element.classList.toggle('active');
      const icon = element.previousElementSibling.querySelector('i');
      icon.classList.toggle('fa-chevron-down');
      icon.classList.toggle('fa-chevron-up');
    }

    function updateAirQualityIndicators(pm1_0, pm2_5, pm10) {
      // –û–±–Ω–æ–≤–ª—è–µ–º –∑–Ω–∞—á–µ–Ω–∏—è
      elements.pm1_0.textContent = pm1_0 !== undefined ? pm1_0 : "--";
      elements.pm2_5.textContent = pm2_5 !== undefined ? pm2_5 : "--";
      elements.pm10.textContent = pm10 !== undefined ? pm10 : "--";

      // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã
      if (pm1_0 !== undefined) {
        elements.pm1_0_indicator.style.width = `${Math.min(pm1_0 / 50 * 100, 100)}%`;
      }
      if (pm2_5 !== undefined) {
        elements.pm2_5_indicator.style.width = `${Math.min(pm2_5 / 50 * 100, 100)}%`;
      }
      if (pm10 !== undefined) {
        elements.pm10_indicator.style.width = `${Math.min(pm10 / 100 * 100, 100)}%`;
      }
    }

    // ===== –§–£–ù–ö–¶–ò–ò –î–õ–Ø API –ü–û–ì–û–î–´ =====
    async function fetchWeatherData() {
      try {
        // –ó–∞–≥—Ä—É–∑–∫–∞ —Ç–µ–∫—É—â–µ–π –ø–æ–≥–æ–¥—ã –∏ –ø—Ä–æ–≥–Ω–æ–∑–∞
        const currentResponse = await fetch(
          `https://api.openweathermap.org/data/2.5/weather?lat=${weatherConfig.lat}&lon=${weatherConfig.lon}&units=${weatherConfig.units}&lang=${weatherConfig.lang}&appid=${weatherConfig.apiKey}`
        );
        
        const forecastResponse = await fetch(
          `https://api.openweathermap.org/data/2.5/forecast?lat=${weatherConfig.lat}&lon=${weatherConfig.lon}&units=${weatherConfig.units}&lang=${weatherConfig.lang}&appid=${weatherConfig.apiKey}&cnt=40`
        );
        
        if (!currentResponse.ok || !forecastResponse.ok) {
          throw new Error('–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö');
        }
        
        const currentData = await currentResponse.json();
        const forecastData = await forecastResponse.json();
        
        // –û–±–Ω–æ–≤–ª—è–µ–º UI
        updateWeatherParams(currentData);
        updateWeatherForecast(forecastData);
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –∫–∞—Ä—Ç—É –ø–æ–≥–æ–¥—ã (–µ—Å–ª–∏ –µ—â–µ –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞)
        if (!elements.weatherMap) {
          initWeatherMap();
        }
        
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –¥–∞–Ω–Ω—ã—Ö –ø–æ–≥–æ–¥—ã:', error);
      }
    }

    function updateWeatherParams(data) {
      elements.weatherWind.textContent = `${data.wind.speed} –º/—Å`;
      elements.weatherHumidity.textContent = `${data.main.humidity}%`;
      
      const precipitation = data.rain ? data.rain["1h"] || 0 : 0;
      elements.weatherPrecipitation.textContent = `${precipitation} –º–º`;
      elements.weatherVisibility.textContent = `${(data.visibility / 1000).toFixed(1)} –∫–º`;
    }

    function updateWeatherForecast(data) {
      // –û—á–∏—â–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
      elements.forecastContainer.innerHTML = '';
      
      // –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –ø–æ –¥–Ω—è–º
      const dailyForecast = {};
      const days = ['–í—Å', '–ü–Ω', '–í—Ç', '–°—Ä', '–ß—Ç', '–ü—Ç', '–°–±'];
      
      data.list.forEach(item => {
        const date = new Date(item.dt * 1000);
        const dayKey = date.toLocaleDateString();
        
        if (!dailyForecast[dayKey]) {
          dailyForecast[dayKey] = {
            date: date,
            temps: [],
            icons: []
          };
        }
        
        dailyForecast[dayKey].temps.push(item.main.temp);
        dailyForecast[dayKey].icons.push(item.weather[0].icon);
      });
      
      // –î–æ–±–∞–≤–ª—è–µ–º –ø—Ä–æ–≥–Ω–æ–∑ –Ω–∞ 5 –¥–Ω–µ–π (—Å–µ–≥–æ–¥–Ω—è + 4 —Å–ª–µ–¥—É—é—â–∏—Ö)
      const forecastDays = Object.keys(dailyForecast).slice(0, 5);
      
      forecastDays.forEach((dayKey, index) => {
        const day = dailyForecast[dayKey];
        const dayName = index === 0 ? '–°–µ–≥–æ–¥–Ω—è' : days[day.date.getDay()];
        
        // –°—Ä–µ–¥–Ω—è—è —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ –∑–∞ –¥–µ–Ω—å
        const minTemp = Math.min(...day.temps);
        const maxTemp = Math.max(...day.temps);
        
        // –ù–∞–∏–±–æ–ª–µ–µ —á–∞—Å—Ç–∞—è –∏–∫–æ–Ω–∫–∞
        const mostFrequentIcon = mode(day.icons);
        
        // –°–æ–∑–¥–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç –¥–Ω—è
        const dayElement = document.createElement('div');
        dayElement.className = 'forecast-day';
        dayElement.innerHTML = `
          <div class="forecast-dayname">${dayName}</div>
          <div class="forecast-icon">
            <img src="https://openweathermap.org/img/wn/${mostFrequentIcon}.png" alt="" width="40">
          </div>
          <div class="forecast-temp">${Math.round(maxTemp)}¬∞/${Math.round(minTemp)}¬∞</div>
        `;
        
        elements.forecastContainer.appendChild(dayElement);
      });
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –Ω–∞—Ö–æ–∂–¥–µ–Ω–∏—è –º–æ–¥—ã (–Ω–∞–∏–±–æ–ª–µ–µ —á–∞—Å—Ç–æ–≥–æ –∑–Ω–∞—á–µ–Ω–∏—è)
    function mode(arr) {
      return arr.sort((a, b) =>
            arr.filter(v => v === a).length
          - arr.filter(v => v === b).length
      ).pop();
    }

    // ===== –ö–ê–†–¢–´ –ü–û–ì–û–î–´ =====
    function initWeatherMap() {
      elements.weatherMap = L.map('weather-map').setView([weatherConfig.lat, weatherConfig.lon], 6);
      
      // –ë–∞–∑–æ–≤–∞—è –∫–∞—Ä—Ç–∞
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '¬© OpenStreetMap'
      }).addTo(elements.weatherMap);
      
      // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–ª–æ–π —Å —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–æ–π
      changeWeatherLayer('temp_new');
    }

    function changeWeatherLayer(layerType) {
      // –£–¥–∞–ª—è–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π —Å–ª–æ–π
      if (elements.currentWeatherLayer) {
        elements.weatherMap.removeLayer(elements.currentWeatherLayer);
      }
      
      // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–π —Å–ª–æ–π
      elements.currentWeatherLayer = L.tileLayer(
        `https://tile.openweathermap.org/map/${layerType}/{z}/{x}/{y}.png?appid=${weatherConfig.apiKey}`, {
          attribution: '¬© OpenWeatherMap',
          opacity: 0.7
        }
      ).addTo(elements.weatherMap);
    }

    // ===== –ö–ê–†–¢–ê –î–ê–¢–ß–ò–ö–ê =====
    function initSensorMap() {
      if (!elements.sensorMap) {
        elements.sensorMap = L.map('sensor-map').setView(SENSOR_COORDS, 13);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          attribution: '¬© OpenStreetMap'
        }).addTo(elements.sensorMap);
        
        elements.sensorMarker = L.marker(SENSOR_COORDS)
          .addTo(elements.sensorMap)
          .bindPopup("<b>–î–∞—Ç—á–∏–∫ V1.0</b><br>–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...");
      }
    }

    // ===== –û–ë–ù–û–í–õ–ï–ù–ò–ï –î–ê–ù–ù–´–• –° –î–ê–¢–ß–ò–ö–ê =====
    function updateSensorData(snapshot) {
      const data = snapshot.val();
      if (data) {
        // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ
        elements.temp.textContent = data.temp !== undefined ? 
          `${data.temp.toFixed(1)}¬∞` : "--¬∞";
          
        elements.pressure.textContent = data.pressure !== undefined ? 
          `${data.pressure.toFixed(1)} –≥–ü–∞` : "-- –≥–ü–∞";
          
        elements.altitude.textContent = data.altitude !== undefined ? 
          `${data.altitude.toFixed(1)} –º` : "-- –º";

        // –û–±–Ω–æ–≤–ª—è–µ–º –∫–∞—á–µ—Å—Ç–≤–æ –≤–æ–∑–¥—É—Ö–∞
        updateAirQualityIndicators(data.pm1_0, data.pm2_5, data.pm10);

        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å
        elements.status.textContent = "–î–∞–Ω–Ω—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω—ã: " + new Date().toLocaleTimeString();
        elements.status.className = "status online";

        // –û–±–Ω–æ–≤–ª—è–µ–º –º–∞—Ä–∫–µ—Ä –Ω–∞ –∫–∞—Ä—Ç–µ
        if (elements.sensorMarker) {
          elements.sensorMarker.setPopupContent(`
            <b>–î–∞—Ç—á–∏–∫ V1.0</b><br>
            üå° ${elements.temp.textContent}<br>
            üìå ${elements.pressure.textContent}<br>
            üèî ${elements.altitude.textContent}<br>
            üí® PM1.0: ${data.pm1_0 || '--'} ¬µg/m¬≥<br>
            üí® PM2.5: ${data.pm2_5 || '--'} ¬µg/m¬≥<br>
            üí® PM10: ${data.pm10 || '--'} ¬µg/m¬≥
          `);
        }
      }
    }

    // ===== –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò –°–û–ë–´–¢–ò–ô =====
    function setupEventListeners() {
      // –ö–Ω–æ–ø–∫–∞ "–ü–æ–∫–∞–∑–∞—Ç—å –∫–∞—Ä—Ç—É –¥–∞—Ç—á–∏–∫–∞"
      elements.showSensorMapBtn.addEventListener("click", () => {
        elements.sensorMapContainer.style.display = "block";
        initSensorMap();
      });

      // –ö–Ω–æ–ø–∫–∞ "–ó–∞–∫—Ä—ã—Ç—å –∫–∞—Ä—Ç—É –¥–∞—Ç—á–∏–∫–∞"
      elements.closeSensorMapBtn.addEventListener("click", () => {
        elements.sensorMapContainer.style.display = "none";
      });
      
      // –ö–Ω–æ–ø–∫–∞ "–û–±–Ω–æ–≤–∏—Ç—å –ø–æ–≥–æ–¥—É"
      elements.refreshWeatherBtn.addEventListener("click", fetchWeatherData);
    }

    // ===== –ó–ê–ü–£–°–ö –ü–†–ò–õ–û–ñ–ï–ù–ò–Ø =====
    document.addEventListener("DOMContentLoaded", () => {
      setupEventListeners();
      
      // –ü–æ–¥–ø–∏—Å—ã–≤–∞–µ–º—Å—è –Ω–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –≤ Firebase
      database.ref('/weather').on('value', updateSensorData, (error) => {
        elements.status.textContent = "–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è: " + error.message;
        elements.status.className = "status offline";
      });
      
      // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–≥–æ–¥—ã
      fetchWeatherData();
      
      // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–≥–æ–¥—É –∫–∞–∂–¥—ã–µ 30 –º–∏–Ω—É—Ç
      setInterval(fetchWeatherData, 30 * 60 * 1000);
    });
  </script>
</body>
</html>
